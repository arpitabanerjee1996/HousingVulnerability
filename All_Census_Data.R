library(tidyverse)
library(tidycensus)
library(readxl)
library(stringr)
census_api_key("936c96236b979ae522c6cf67edb51923cd391fb3")

#Race
Minority_2019<-get_acs(geography = "tract", state = "IL", county = "031", table = "B02001", year=2019, survey="acs5", output="wide")%>% 
  mutate(pop_other = B02001_001E-(B02001_002E + B02001_003E+ B02001_005E)) %>% 
  rename(pop_tot = B02001_001E, pop_white = B02001_002E, pop_black = B02001_003E, pop_asian = B02001_005E) %>% 
  mutate(pop_nonwhite = pop_tot - pop_white, 
         p_white = (pop_white/pop_tot)*100,
         p_nonwhite = (pop_nonwhite/pop_tot)*100,
         p_black = (pop_black/pop_tot)*100,
         p_asian = (pop_asian / pop_tot)*100,
         p_other = (pop_other/pop_tot)*100) %>% 
  select(GEOID, pop_tot, pop_white, p_white,
         pop_nonwhite, p_nonwhite, 
         pop_black, p_black,
         pop_asian, p_asian,
         pop_other, p_other)

#Cost Burden
CostBurden_2019 <- get_acs(
  geography = "tract",
  state = "IL",
  county = "031",
  table = "B25106",
  year = 2019,
  survey = "acs5",
  output = "wide"
) %>%
  mutate(TotalHH=B25106_001E, 
         Owner_Occupied_Units=B25106_002E,
         CostBurdened=B25106_006E+B25106_010E+B25106_014E+B25106_018E+B25106_022E,
         Percent_CostBurdened = (CostBurdened*100)/Owner_Occupied_Units,
         Rented_Units=B25106_024E,
         RentBurdened=B25106_028E+B25106_032E+B25106_036E+B25106_040E+B25106_044E,
         Percent_RentBurdened = (RentBurdened*100)/Rented_Units,
         Percent_Burdened = ((CostBurdened+RentBurdened)*100)/Total) %>% 
  select(GEOID, Total, 
         Owner_Occupied_Units, CostBurdened, Percent_CostBurdened,
         Rented_Units, RentBurdened, Percent_RentBurdened,
         Percent_Burdened)

#Households at 30% or below of area median incomes 
IncomeBurden_2019 <- get_acs(
  geography = "tract",
  state = "IL",
  county = "031",
  table = "S1901",
  year = 2019,
  survey = "acs5",
  output = "wide"
) %>% select(GEOID,
             HH_tot=S1901_C01_001E,
             P_LessThan10000=S1901_C01_002E, 
             P_14999to10000=S1901_C01_003E,
             P_15000to24999=S1901_C01_004E,
             P_25000to34999=S1901_C01_005E,
             P_35000to49999=S1901_C01_006E
             ) %>% mutate(P_LessThanMedian = P_LessThan10000+P_14999to10000+P_15000to24999+P_25000to34999+P_35000to49999,
                          HH_LessThanMedian = P_LessThanMedian*0.01*HH_tot,
                          P_Median30Percent = P_LessThan10000+P_14999to10000,
                          HH_Median30Percent = P_Median30Percent*0.01*HH_tot) %>% select(GEOID, P_LessThanMedian, HH_LessThanMedian, P_Median30Percent, HH_Median30Percent)

#Age Distribution
Age_2017 <-
  get_acs(
    geography = "tract",
    state = "IL",
    county = "031",
    table = "B01001",
    year = 2019,
    survey = "acs5",
    output = "wide",
    cache_table = TRUE
  )%>% mutate (pop_tot = B01001_001E, 
               pop_18under = B01001_003E+B01001_004E+B01001_005E+B01001_006E,
               pop_64above = B01001_020E+B01001_021E+B01001_022E+B01001_023E+B01001_024E,
               pop_vulnerable_age = pop_18under+pop_64above, 
               P_vulnerableAge = (pop_vulnerable_age*100)/pop_tot) %>% 
  select(GEOID, pop_vulnerable_age, P_vulnerableAge)
  
#Income
MHHI_2019 <- get_acs(
  geography = "tract",
  state = "IL",
  county = "031",
  table = "B19013",
  year = 2019,
  survey = "acs5",
  output = "wide"
) %>% 
  select(GEOID, MHHI_tot = B19013_001E)

#Poverty
Poverty_2019 <- get_acs(
  geography = "tract",
  state = "IL",
  county = "031",
  table = "S1701",
  year = 2019,
  survey = "acs5",
  output = "wide"
) %>% 
  select(GEOID, Pop_tot = S1701_C01_001E, Pop_BelowPoverty = S1701_C02_001E) %>% 
  mutate(Percent_pov = (Pop_BelowPoverty*100)/Pop_tot)

#Without a High School Degree
WithoutHighSchool_2019 <- get_acs(
  geography = "tract",
  state = "IL",
  county = "031",
  table = "S1501",
  year = 2019,
  survey = "acs5",
  output = "wide", cache_table = TRUE
) %>% mutate(WithoutHighSchool_2019 = S1501_C01_002E+
               (S1501_C01_006E-S1501_C01_009E)+
               (S1501_C01_016E-S1501_C01_017E)+
               (S1501_C01_019E-S1501_C01_020E)+
               (S1501_C01_022E-S1501_C01_023E)+
               (S1501_C01_025E-S1501_C01_026E)) %>% 
  select(GEOID, WithoutHighSchool_2019)

#Unemployment
Unemployment_2019 <- get_acs(
  geography = "tract",
  state = "IL",
  county = "031",
  table = "S2301",
  year = 2019,
  survey = "acs5",
  output = "wide"
) %>% 
  select(GEOID,Tot_WorkingAge = S2301_C01_001E, Percent_Employed = S2301_C02_001E) %>% 
  mutate(Percent_Unemployed = 100-Percent_Employed)

#Vacancy
Vacancy_2019 <- get_acs(
  geography = "tract",
  state = "IL",
  county = "031",
  table = "B25002",
  year = 2019,
  survey = "acs5",
  output = "wide"
) %>% 
  select(GEOID,
         Total_units = B25002_001E,
         Occupied = B25002_002E,
         Vacant = B25002_003E) %>% 
  mutate(Percent_occupied = (Occupied*100)/Total_units,
         Percent_vacant = (Vacant*100)/Total_units)

SocioEconomic_2019 <- left_join( Poverty_2019, Unemployment_2019, by ="GEOID")
SocioEconomic_2019 <- left_join( SocioEconomic_2019,MHHI_2019, by ="GEOID") 
SocioEconomic_2019 <- left_join( SocioEconomic_2019,WithoutHighSchool_2019, by ="GEOID")

Demo_Housing_2019<- left_join( CostBurden_2019, IncomeBurden_2019, by ="GEOID")
Demo_Housing_2019<- left_join( Demo_Housing_2019, Age_2017, by ="GEOID")
Demo_Housing_2019<- left_join( Demo_Housing_2019, Minority_2019, by ="GEOID")
Demo_Housing_2019<- left_join( Demo_Housing_2019, Vacancy_2019, by ="GEOID")

rm(CostBurden_2019, Poverty_2019, Unemployment_2019, MHHI_2019, WithoutHighSchool_2019, IncomeBurden_2019, Age_2017,Minority_2019, Vacancy_2019)
write.csv(Demo_Housing_2019, file = "Demographic_andHousing_2019.csv")
write.csv(SocioEconomic_2019, file = "SocioEconomic_Characteristics_2019.csv")